<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/security"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:beans="http://www.springframework.org/schema/beans"
	xmlns:util="http://www.springframework.org/schema/util"
	xsi:schemaLocation="http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-4.2.xsd
		http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd
		http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util-4.3.xsd">
	
	<beans:bean id="passwordEncoder"  class="org.springframework.security.crypto.password.StandardPasswordEncoder">
		<beans:constructor-arg name="secret" value="STIXU"/>
	</beans:bean>
	
		<!-- 登录地址不过滤 -->
	<http pattern="${login.url}" security="none"/>
	<http pattern="${login.fail.url}" security="none"/>
	<http pattern="/security/**" security="none"/>
	
	<beans:bean id="accessDecisionManager" class="org.springframework.security.access.vote.AffirmativeBased">
		<beans:constructor-arg>
			<beans:list>
				<beans:bean class="org.springframework.security.access.vote.RoleVoter">
					<beans:property name="rolePrefix" value="ROLE_"/>
				</beans:bean>
			</beans:list>
		</beans:constructor-arg>
		<beans:property name="allowIfAllAbstainDecisions" value="true"/>
	</beans:bean>
	
	<!-- 运行时安全管理器,保护正在运行的授权信息(内核,角色) -->
	<beans:bean id="runAsManager" class="org.springframework.security.access.intercept.RunAsManagerImpl">
		<beans:property name="key" value="STIXU_SEC_KEY"/>
		<beans:property name="rolePrefix"  value="ROLE_"/>
	</beans:bean>

	<beans:bean id="filterSecurityInterceptor" class="org.springframework.security.web.access.intercept.FilterSecurityInterceptor">
		<beans:property name="authenticationManager" ref="authenticationManager"/>
		<beans:property name="accessDecisionManager" ref="accessDecisionManager"/>
		<beans:property name="alwaysReauthenticate" value="false"/>
		<beans:property name="securityMetadataSource">
			<beans:bean class="com.stixu.security.UrlFilterInvocationSecurityMetadataSource">
				<beans:constructor-arg name="roleService" ref="roleService"/>
				<beans:constructor-arg name="menuService" ref="menuService"/>
			</beans:bean>
		</beans:property>
	</beans:bean>
	
	<!-- 地址安全过滤器 -->
	<http use-expressions="false" access-decision-manager-ref="accessDecisionManager"
								  auto-config="true"	
								  authentication-manager-ref="authenticationManager">
		<custom-filter before="FILTER_SECURITY_INTERCEPTOR" ref="filterSecurityInterceptor"/>
		<csrf disabled="true"/>
		<form-login login-page="${login.url}"
					login-processing-url="${login.process.url}"
					password-parameter="j_password"
					username-parameter="j_username"
					authentication-failure-forward-url="${login.fail.url}"
					authentication-success-forward-url="${login.success.url}"
					default-target-url="${home.url}"
					always-use-default-target="false"/>
		<logout logout-url="${logout.url}"
				invalidate-session="true"
				logout-success-url="${login.url}"/>
	</http>
	
	<authentication-manager id="authenticationManager">
		<authentication-provider user-service-ref="accountService">
			<password-encoder ref="passwordEncoder"/>
		</authentication-provider>
	</authentication-manager>
	
</beans:beans>
