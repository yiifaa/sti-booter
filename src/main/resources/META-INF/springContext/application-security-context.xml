<?xml version="1.0" encoding="UTF-8"?>
<beans:beans xmlns="http://www.springframework.org/schema/security"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xmlns:beans="http://www.springframework.org/schema/beans"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-4.3.xsd
		http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security-4.2.xsd">
	<!--
	<http pattern="/app/login/**" security="none"/>
	
	<http auto-config="true" request-matcher="mvc">
		<intercept-url pattern="/sti/**" access="hasRole('USER')" />
		<csrf disabled="true"/>
		
		<form-login login-page="/sti/login/index"
					login-processing-url="/app/login/check"
					password-parameter="j_password"
					username-parameter="j_username"
					authentication-failure-forward-url="/app/login/fail"
					authentication-success-forward-url="/sti/home"
					default-target-url="/sti/home"
					always-use-default-target="false"/>
					
		<logout logout-url="/app/login/out"
				invalidate-session="true"
				logout-success-url="/app/login/index"/>			
	</http>
	-->
	
	<beans:bean id="passwordEncoder"  class="org.springframework.security.crypto.password.StandardPasswordEncoder">
		<beans:constructor-arg name="secret" value="STIXU"/>
	</beans:bean>
	
	<beans:bean id="accessDecisionManager" class="org.springframework.security.access.vote.AffirmativeBased">
		<beans:constructor-arg>
			<beans:list>
				<beans:bean class="org.springframework.security.access.vote.RoleVoter">
					<beans:property name="rolePrefix" value="ROLE_"/>
				</beans:bean>
			</beans:list>
		</beans:constructor-arg>
		<beans:property name="allowIfAllAbstainDecisions" value="true"/>
	</beans:bean>
	
	<!-- 运行时安全管理器,保护正在运行的授权信息(内核,角色) -->
	<beans:bean id="runAsManager" class="org.springframework.security.access.intercept.RunAsManagerImpl">
		<beans:property name="key" value="STIXU_SEC_KEY"/>
		<beans:property name="rolePrefix"  value="ROLE_"/>
	</beans:bean>
	
	<beans:bean id="filterSecurityInterceptor" class="org.springframework.security.web.access.intercept.FilterSecurityInterceptor">
		<beans:property name="authenticationManager" ref="authenticationManager"/>
		<beans:property name="accessDecisionManager" ref="accessDecisionManager"/>
		<beans:property name="alwaysReauthenticate" value="false"/>
		<beans:property name="securityMetadataSource">
			<beans:bean class="com.stixu.security.UrlFilterInvocationSecurityMetadataSource">
				<beans:constructor-arg name="roleService" ref="roleService"/>
				<beans:constructor-arg name="menuService" ref="menuService"/>
			</beans:bean>
		</beans:property>
	</beans:bean>
	
	<http use-expressions="true" access-decision-manager-ref="accessDecisionManager"
								 auto-config="true"	
								 authentication-manager-ref="authenticationManager">
		<!-- 					  
		<intercept-url pattern="/login/*" access="permitAll"/>
			
		<intercept-url pattern="/app/**" access="hasRole('USER')" />
		 -->
		<custom-filter before="FILTER_SECURITY_INTERCEPTOR" ref="filterSecurityInterceptor"/>
		<anonymous enabled="true" granted-authority="ROLE_ANONYMOUS"/> 
		<csrf disabled="true"/>
		<form-login authentication-success-forward-url="/app/home"
					authentication-failure-forward-url="/app/login/fail"
					always-use-default-target="false"
					default-target-url="/app/home"
					login-page="/index.html"
					login-processing-url="/login/check"/>
					
		<logout invalidate-session="true"
				logout-url="/login/out"/>
	</http>
	
	<authentication-manager id="authenticationManager">
		<authentication-provider user-service-ref="accountService">
			<password-encoder ref="passwordEncoder"/>
		</authentication-provider>
	</authentication-manager>
	
</beans:beans>
